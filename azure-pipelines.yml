trigger:
  batch: true
  branches:
    include:
      - master
      - develop
  paths:
    exclude:
      - LICENSE
      - README.md

pool:
  vmImage: 'Ubuntu-16.04'

variables:
  configuration: 'Release'
  prerelease: ci
  srcDir: '$(Join-Path -Path build.sourcesDirectory -ChildPath "src")'

steps:
  - task: DotNetCoreCLI@2
    displayName: dotnet build
    inputs:
      command: build
      projects: '**/*.csproj'
      configuration: $(configuration)
  
  - task: DotNetCoreCLI@2
    displayName: dotnet test
    inputs:
      command: test
      projects: 'test/**/*.csproj'
      configuration: $(configuration)
      nobuild: true

  - task: DotNetCoreCLI@2
    displayName: dotnet pack
    inputs:
      command: pack
      packDirectory: '$(build.artifactStagingDirectory)/packages'
      workingDirectory: '$(srcDir)'
      configuration: $(configuration)
      nobuild: true
 
  - task: PublishBuildArtifacts@1
    displayName: publish artifacts
    #condition: $(and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master')))
    inputs:
      PathtoPublish: '$(build.artifactStagingDirectory)'

  - task: DotNetCoreCLI@2
    displayName: dotnet nuget push
    #condition: $(and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master')))
    inputs:
      command: custom
      custom: nuget
      arguments: push $(build.artifactStagingDirectory)/packages/*.nupkg --source https://api.nuget.org/v3/index.json --no-service-endpoint --api-key $(nuget.apiKey)      
